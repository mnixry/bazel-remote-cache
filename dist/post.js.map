{"version":3,"file":"post.js","sources":["../src/post.ts"],"sourcesContent":["import * as fs from 'node:fs/promises'\n\nimport * as core from '@actions/core'\nimport { sleep, errorMessage } from './utils.js'\n\nexport async function runPost(): Promise<void> {\n  try {\n    const pidRaw = core.getState('server_pid')\n    const logPath = core.getState('log_path')\n\n    if (pidRaw) {\n      const pid = parseInt(pidRaw, 10)\n      if (Number.isFinite(pid)) {\n        await terminateProcess(pid)\n      }\n    }\n\n    if (logPath) {\n      await printLogFile(logPath)\n    }\n  } catch (error) {\n    // Post should never fail the job\n    core.warning(errorMessage(error))\n  }\n}\n\nasync function terminateProcess(pid: number): Promise<void> {\n  if (!isRunning(pid)) return\n\n  process.kill(pid, 'SIGTERM')\n\n  const deadline = Date.now() + 5_000\n  while (Date.now() < deadline) {\n    if (!isRunning(pid)) return\n    await sleep(200)\n  }\n\n  // Force kill if still running\n  if (isRunning(pid)) {\n    process.kill(pid, 'SIGKILL')\n  }\n}\n\nfunction isRunning(pid: number): boolean {\n  try {\n    process.kill(pid, 0)\n    return true\n  } catch {\n    return false\n  }\n}\n\nasync function printLogFile(logPath: string): Promise<void> {\n  core.startGroup(`bazel-remote-cache logs (${logPath})`)\n  try {\n    const stat = await fs.stat(logPath)\n    const maxBytes = 1024 * 1024\n\n    if (stat.size <= maxBytes) {\n      const content = await fs.readFile(logPath, 'utf8')\n      process.stdout.write(content)\n    } else {\n      const fh = await fs.open(logPath, 'r')\n      const start = Math.max(0, stat.size - maxBytes)\n      const buf = Buffer.alloc(stat.size - start)\n      await fh.read(buf, 0, buf.length, start)\n      await fh.close()\n      process.stdout.write(\n        `... (truncated, last ${buf.length} of ${stat.size} bytes) ...\\n`\n      )\n      process.stdout.write(buf.toString('utf8'))\n    }\n  } catch (error) {\n    core.warning(`failed to read log: ${errorMessage(error)}`)\n  } finally {\n    core.endGroup()\n  }\n}\n\n/* istanbul ignore next */\nrunPost()\n"],"names":["core.getState","core.warning","core.startGroup","fs","core.endGroup"],"mappings":"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"}