{"version":3,"file":"index.js","sources":["../src/main.ts","../src/index.ts"],"sourcesContent":["import * as fs from 'node:fs'\nimport * as os from 'node:os'\nimport * as path from 'node:path'\nimport { fileURLToPath } from 'node:url'\nimport { spawn } from 'node:child_process'\n\nimport * as core from '@actions/core'\nimport { sleep, errorMessage } from './utils.js'\n\ntype HealthzResponse = {\n  status?: string\n  backend?: { ok?: boolean; message?: string }\n}\n\nexport async function run(): Promise<void> {\n  try {\n    const host = core.getInput('host') || '127.0.0.1'\n    const port = parseInt(core.getInput('port') || '7777', 10)\n    const namespace = core.getInput('namespace') || 'bazel-remote-cache'\n    const healthTimeoutMs = parseInt(\n      core.getInput('health_timeout_ms') || '15000',\n      10\n    )\n    const logLevel = core.getInput('log_level') || 'info'\n\n    const connectHost = host === '0.0.0.0' || host === '::' ? '127.0.0.1' : host\n    const remoteCacheUrl = `http://${connectHost}:${port}`\n\n    const tmpBaseDir = process.env.RUNNER_TEMP ?? os.tmpdir()\n    const logDir = path.join(tmpBaseDir, 'bazel-remote-cache-logs')\n    fs.mkdirSync(logDir, { recursive: true })\n\n    const logPath = path.join(logDir, `server-${Date.now()}-${process.pid}.log`)\n    core.saveState('log_path', logPath)\n\n    const storeDir = path.join(tmpBaseDir, 'bazel-remote-cache-store')\n\n    const logFd = fs.openSync(logPath, 'a')\n    const serverPath = path.join(\n      path.dirname(fileURLToPath(import.meta.url)),\n      'server.js'\n    )\n\n    const child = spawn(process.execPath, [serverPath], {\n      detached: true,\n      stdio: ['ignore', logFd, logFd],\n      env: {\n        ...process.env,\n        BAZEL_REMOTE_CACHE_HOST: host,\n        BAZEL_REMOTE_CACHE_PORT: String(port),\n        BAZEL_REMOTE_CACHE_NAMESPACE: namespace,\n        BAZEL_REMOTE_CACHE_LOG_LEVEL: logLevel,\n        BAZEL_REMOTE_CACHE_STORE_DIR: storeDir\n      }\n    })\n\n    fs.closeSync(logFd)\n\n    if (!child.pid) {\n      throw new Error('failed to spawn server process')\n    }\n\n    core.saveState('server_pid', String(child.pid))\n    child.unref()\n\n    await waitForHealthz(remoteCacheUrl, healthTimeoutMs)\n    core.setOutput('remote_cache_url', remoteCacheUrl)\n  } catch (error) {\n    core.setFailed(errorMessage(error))\n  }\n}\n\nasync function waitForHealthz(\n  baseUrl: string,\n  timeoutMs: number\n): Promise<void> {\n  const healthzUrl = `${baseUrl}/healthz`\n  const deadline = Date.now() + timeoutMs\n\n  let lastError: unknown\n  while (Date.now() < deadline) {\n    try {\n      const res = await fetch(healthzUrl)\n      const body = (await res.json().catch(() => ({}))) as HealthzResponse\n      if (res.ok && body?.backend?.ok !== false) return\n      lastError = new Error(\n        `not ready: status=${res.status} backend_ok=${body?.backend?.ok}`\n      )\n    } catch (err) {\n      lastError = err\n    }\n    await sleep(250)\n  }\n\n  throw new Error(\n    `health check timed out: ${errorMessage(lastError)} (${healthzUrl})`\n  )\n}\n","/**\n * The entrypoint for the action. This file simply imports and runs the action's\n * main logic.\n */\nimport { run } from './main.js'\n\n/* istanbul ignore next */\nrun()\n"],"names":["core.getInput","os","core.saveState","core.setOutput","core.setFailed"],"mappings":"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"}